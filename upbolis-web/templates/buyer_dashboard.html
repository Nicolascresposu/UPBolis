{% extends "base.html" %}
{% load static %}

{% block title %}Panel de usuario · UPBolis{% endblock %}

{% block content %}
<div class="dashboard">

    <!-- HEADER -->
    <header class="dashboard__header">
        <div>
            <h1 class="dashboard__title">Panel de usuario</h1>
            <p class="dashboard__subtitle">
                Hola, {{ user_name|default:"Usuario" }}. Administra tu saldo, compras y movimientos de UPBolis.
            </p>
        </div>

        <div class="dashboard__header-actions">
            <a href="{% url 'logout' %}" class="btn btn-ghost btn-ghost--danger">
                Cerrar sesión
            </a>
        </div>
    </header>

    <!-- KPIs -->
    <section class="dashboard-grid">
        <article class="stat-card">
            <div class="stat-card__label">Saldo disponible</div>
            <div class="stat-card__value">
                {{ wallet.balance|default:"0.00" }} <span class="stat-card__tag">UPBolis</span>
            </div>
            <p class="stat-card__hint">Wallet ID: {{ wallet.id|default:"—" }}</p>
        </article>

        <article class="stat-card">
            <div class="stat-card__label">Órdenes realizadas</div>
            <div class="stat-card__value">{{ stats.total_orders|default:"0" }}</div>
            <p class="stat-card__hint">Incluye órdenes completadas y en proceso.</p>
        </article>

        <article class="stat-card">
            <div class="stat-card__label">Gasto total</div>
            <div class="stat-card__value">
                {{ stats.total_spent|default:"0.00" }} <span class="stat-card__tag">UPBolis</span>
            </div>
            <p class="stat-card__hint">Desde que creaste tu cuenta.</p>
        </article>
    </section>

    <!-- CATÁLOGO DE PRODUCTOS -->
    <section class="panel" style="margin-bottom: 2rem;">
        <header class="panel__header">
            <div>
                <h2 class="panel__title">Catálogo de productos</h2>
                <p class="panel__subtitle">
                    Elige qué quieres comprar con tus UPBolis.
                </p>
            </div>
        </header>

        <div class="table-wrapper table-wrapper--compact">
            <table class="table table--compact">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Seller</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th class="table__th--right">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <div class="table-main-text">{{ product.name }}</div>
                            <div class="table-sub-text">{{ product.description|default:"" }}</div>
                        </td>
                        <td>{{ product.seller_name|default:"—" }}</td>
                        <td>{{ product.price }} UPB</td>
                        <td>{{ product.stock }}</td>
                        <td class="table__td--right">
                            <form method="post" action="{% url 'create_order' %}">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <button type="submit" class="btn btn-small btn-primary">
                                    Comprar
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="table-empty">
                            No hay productos disponibles por ahora.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- FILA: ENVIAR + ACTIVIDAD RECIENTE -->
    <div class="dashboard-columns">

        <!-- ENVIAR UPBOLIS -->
        <section class="panel">
            <header class="panel__header">
                <div>
                    <h2 class="panel__title">Enviar UPBolis</h2>
                    <p class="panel__subtitle">
                        Transfiere saldo a otro usuario de la plataforma.
                    </p>
                </div>
            </header>

            <form method="post" action="{% url 'wallet_transfer' %}" class="auth-form">
                {% csrf_token %}

                <div class="form-grid">
                    <div class="field field--full">
                        <label for="to_email">Destinatario</label>
                        <select id="to_email" name="to_email" class="select-small" required>
                            <option value="">Selecciona un usuario…</option>
                            {% for u in recipients %}
                            <option value="{{ u.email }}">
                                {{ u.name }} ({{ u.email }})
                            </option>
                            {% endfor %}
                        </select>
                        <p class="field__hint">
                            Solo se muestran usuarios distintos a ti.
                        </p>
                    </div>

                    <div class="field">
                        <label for="amount">Monto a enviar</label>
                        <input
                            type="number"
                            step="0.01"
                            min="0.01"
                            id="amount"
                            name="amount"
                            placeholder="Ejemplo: 10.5"
                            required
                        >
                        <p class="field__hint">
                            Se descontará de tu saldo actual.
                        </p>
                    </div>

                    <div class="field field--full">
                        <label for="reason">Motivo (opcional)</label>
                        <input
                            type="text"
                            id="reason"
                            name="reason"
                            maxlength="255"
                            placeholder="Ejemplo: almuerzo, préstamo, etc."
                        >
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn--full" style="margin-top: 1rem;">
                    Enviar UPBolis
                </button>
            </form>
        </section>

        <!-- ACTIVIDAD RECIENTE -->
        <section class="panel">
            <header class="panel__header panel__header--tabs">
                <div>
                    <h2 class="panel__title">Actividad reciente</h2>
                    <p class="panel__subtitle">
                        Tus últimas órdenes y movimientos de wallet.
                    </p>
                </div>
            </header>

            <!-- ÓRDENES -->
            <h3 class="panel__subheading">Órdenes</h3>
            <div class="table-wrapper table-wrapper--compact">
                <table class="table table--compact">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>
                                <span class="date-cell"
                                      data-iso="{{ order.created_at }}">
                                    {{ order.created_at_display|default:order.created_at }}
                                </span>
                            </td>
                            <td>
                                <span class="chip chip--{{ order.status }}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>{{ order.total }} UPB</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="table-empty">
                                Aún no tienes órdenes registradas.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- TRANSACCIONES -->
            <h3 class="panel__subheading panel__subheading--mt">Transacciones</h3>
            <div class="table-wrapper table-wrapper--compact">
                <table class="table table--compact">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Detalle</th>
                            <th>Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in transactions %}
                        <tr>
                            <td>
                                <span class="date-cell"
                                      data-iso="{{ tx.created_at }}">
                                    {{ tx.created_at_display|default:tx.created_at }}
                                </span>
                            </td>
                            <td>{{ tx.type|title }}</td>
                            <td>{{ tx.description|default:"—" }}</td>
                            <td class="table__td--amount {% if tx.amount > 0 %}amount--positive{% elif tx.amount < 0 %}amount--negative{% endif %}">
                                {{ tx.amount }} UPB
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="table-empty">
                                Aún no tienes movimientos en tu wallet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

    </div> <!-- /dashboard-columns -->

</div> <!-- /dashboard -->

<!-- JS PARA FORMATEAR FECHAS (igual estilo que admin) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dateCells = document.querySelectorAll('.date-cell[data-iso]');
    const opts = {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };

    dateCells.forEach(el => {
        const iso = el.dataset.iso;
        if (!iso) return;

        const d = new Date(iso);
        if (isNaN(d.getTime())) return;

        let formatted = d.toLocaleString('es-BO', opts);
        formatted = formatted.replace(',', ''); // quitar coma si aparece
        el.textContent = formatted;
    });
});
</script>

{% endblock %}
