{% extends "base.html" %}
{% load static %}

{% block title %}Panel de usuario · UPBolis{% endblock %}

{% block content %}
<div class="dashboard">

    <header class="dashboard__header">
        <div>
            <h1 class="dashboard__title">Hola, {{ user_name|default:"Usuario" }}</h1>
            <p class="dashboard__subtitle">
                Bienvenido a tu panel UPBolis. Administra tu saldo, tus compras y tus órdenes.
            </p>
        </div>
        <div class="dashboard__header-actions">
            <a href="{% url 'logout' %}" class="btn btn-secondary">Cerrar sesión</a>
        </div>
    </header>

    <!-- RESUMEN -->
    <section class="dashboard-grid">
        <article class="stat-card">
            <div class="stat-card__label">Saldo disponible</div>
            <div class="stat-card__value">
                {{ wallet.balance|default:"0.00" }} <span class="stat-card__tag">UPBolis</span>
            </div>
            <p class="stat-card__hint">Wallet ID: {{ wallet.id|default:"—" }}</p>
        </article>

        <article class="stat-card">
            <div class="stat-card__label">Órdenes realizadas</div>
            <div class="stat-card__value">{{ stats.total_orders|default:"0" }}</div>
            <p class="stat-card__hint">Incluye órdenes completadas y en proceso.</p>
        </article>

        <article class="stat-card">
            <div class="stat-card__label">Gasto total</div>
            <div class="stat-card__value">
                {{ stats.total_spent|default:"0.00" }} <span class="stat-card__tag">UPBolis</span>
            </div>
            <p class="stat-card__hint">Desde que creaste tu cuenta.</p>
        </article>
    </section>

    <div class="dashboard-columns">
        <!-- PRODUCTOS DISPONIBLES -->
        <section class="panel">
            <header class="panel__header">
                <div>
                    <h2 class="panel__title">Catálogo de productos</h2>
                    <p class="panel__subtitle">
                        Elige qué quieres comprar con tus UPBolis.
                    </p>
                </div>
            </header>

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Seller</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th class="table__th--right">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>
                                <div class="table-main-text">{{ product.name }}</div>
                                <div class="table-sub-text">{{ product.description|default:"" }}</div>
                            </td>
                            <td>{{ product.seller_name|default:"—" }}</td>
                            <td>{{ product.price }} UPB</td>
                            <td>{{ product.stock }}</td>
                            <td class="table__td--right">
                                <form method="post" action="{% url 'create_order' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ product.id }}">
                                    <button type="submit" class="btn btn-small btn-primary">
                                        Comprar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="table-empty">
                                No hay productos disponibles por ahora.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ÓRDENES & TRANSACCIONES -->
        <section class="panel">
            <header class="panel__header panel__header--tabs">
                <div>
                    <h2 class="panel__title">Actividad reciente</h2>
                    <p class="panel__subtitle">
                        Tus últimas órdenes y movimientos de wallet.
                    </p>
                </div>
            </header>

            <h3 class="panel__subheading">Órdenes</h3>
            <div class="table-wrapper table-wrapper--compact">
                <table class="table table--compact">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>{{ order.created_at }}</td>
                            <td>
                                <span class="chip chip--{{ order.status }}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>{{ order.total }} UPB</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="table-empty">
                                Aún no tienes órdenes registradas.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h3 class="panel__subheading">Transacciones</h3>
            <div class="table-wrapper table-wrapper--compact">
                <table class="table table--compact">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Detalle</th>
                            <th>Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in transactions %}
                        <tr>
                            <td>{{ tx.created_at }}</td>
                            <td>{{ tx.type|title }}</td>
                            <td>{{ tx.description|default:"—" }}</td>
                            <td class="table__td--amount {% if tx.amount > 0 %}amount--positive{% elif tx.amount < 0 %}amount--negative{% endif %}">
                                {{ tx.amount }} UPB
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="table-empty">
                                Aún no tienes movimientos en tu wallet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

</div>
{% endblock %}
